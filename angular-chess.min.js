!function(){"use strict";angular.module("nywton.chess",["nywton.chessboard"]).service("NywtonChessGameService",["$log",function(a){this.onDragStart=function(b,c,d,e,f){return a.debug("lift piece "+d+" from "+c+" - "+e+" - "+f),b.game_over()===!0||"w"===b.turn()&&-1!==d.search(/^b/)||"b"===b.turn()&&-1!==d.search(/^w/)?!1:!0},this.onDrop=function(b,c,d){var e=b.move({from:c,to:d,promotion:"q"});return null===e?(a.log("Illegal move.. cannot move from "+c+" to "+d),"snapback"):void a.debug("moved from "+c+" to "+d)},this.onSnapEnd=function(b,c,d,e,f){a.debug("onSnapEnd "+f+" from "+d+" to "+e),c.position(b.fen())},this.makeRandomMove=function(b,c){a.info("position: "+b.fen());var d=b.moves(),e=d[Math.floor(Math.random()*d.length)];b.move(e);var f=!0;c.position(b.fen(),f),a.info("move: "+e)}}]).directive("nywtonChessgame",["$window","$log","NywtonChessGameService",function(a,b,c){var d={restrict:"E",template:'<div><nywton-chessboard board="board" position="\'start\'" draggable="true" on-change="onChange" on-drag-start-cb="onDragStart" on-snap-end="onSnapEnd" on-drop="onDrop"></nywton-chessboard></div>',replace:!1,scope:{name:"@",game:"=",board:"="},controller:["$scope",function(b){var d=b.game=new a.Chess;d.name=b.name||"game"+b.$id,this.game=function(){return b.game},this.board=function(){return b.board},b.onDragStart=function(a,d,e,f){return c.onDragStart(b.game,a,d,e,f)},b.onSnapEnd=function(a,d,e){return c.onSnapEnd(b.game,b.board,a,d,e)},b.onDrop=function(a,d){return c.onDrop(b.game,a,d)},b.onChange=function(a,b){return angular.noop(a,b)}}]};return d}]).directive("nywtonAllowOnlyLegalMoves",["$window","NywtonChessGameService",function(a,b){var c={restrict:"A",priority:1,require:"nywtonChessboard",controller:[function(){var c=new a.Chess;this.onDragStart=function(a,d,e,f){return b.onDragStart(c,a,d,e,f)},this.getOnSnapEndFunc=function(a){return function(d,e,f){return b.onSnapEnd(c,a(),d,e,f)}},this.onDrop=function(a,d){return b.onDrop(c,a,d)},this.onChange=function(){}}],link:function(a,b,c,d){var e=b.controller("nywtonAllowOnlyLegalMoves"),f=function(){return d.board()};d.config_push(["onDragStart",e.onDragStart]),d.config_push(["onSnapEnd",e.getOnSnapEndFunc(f)]),d.config_push(["onDrop",e.onDrop]),d.config_push(["onChange",e.onChange])}};return c}]).directive("nywtonRandomVsRandom",["$timeout","$log","NywtonChessGameService",function(a,b,c){var d={restrict:"A",priority:1,require:"nywtonChessgame",controller:["$scope",function(b){var d=null;this.delayedInvocation=function e(b,f){d=a(function(){b.game_over()!==!0&&b.in_draw()!==!0&&(c.makeRandomMove(b,f),e(b,f))},500)},b.$on("$destroy",function(){a.cancel(d)})}],link:function(b,c,d,e){var f=c.controller("nywtonRandomVsRandom");a(function(){var a=e.game(),b=e.board();f.delayedInvocation(a,b)},0)}};return d}])}();