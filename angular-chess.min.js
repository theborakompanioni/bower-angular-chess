!function(){"use strict";angular.module("nywton.chess",["nywton.chessboard"]).service("NywtonChessGameService",["$log",function(a){this.onDragStart=function(b,c,d,e,f){return a.debug("lift piece "+d+" from "+c+" - "+e+" - "+f),b.game_over()===!0||"w"===b.turn()&&-1!==d.search(/^b/)||"b"===b.turn()&&-1!==d.search(/^w/)?!1:!0},this.onDrop=function(b,c,d){var e=b.move({from:c,to:d,promotion:"q"});return null===e?(a.log("Illegal move.. cannot move from "+c+" to "+d),"snapback"):void a.debug("moved from "+c+" to "+d)},this.onSnapEnd=function(b,c,d,e,f){a.debug("onSnapEnd "+f+" from "+d+" to "+e),c.position(b.fen())}}]).directive("chessgame",["$window","$log","NywtonChessGameService",function(a,b,c){var d={restrict:"E",template:'<div><chessboard board="board" on-change="onChange" on-drag-start-cb="onDragStart" on-snap-end="onSnapEnd" on-drop="onDrop"></chessboard></div>',replace:!1,scope:{name:"@",game:"=",board:"="},controller:["$scope",function(d){var e=d.game=new a.Chess;e.name=d.name||"game"+d.$id,d.onDragStart=function(a,e,f,g){b.debug("onDragStart "+a+","+e+","+f+","+g);var h=c.onDragStart(d.game,a,e,f,g);return d.$parent.$digest(),h},d.onSnapEnd=function(a,e,f){b.debug("onSnapEnd "+a+","+e+","+f);var g=c.onSnapEnd(d.game,d.board);return d.$parent.$digest(),g},d.onDrop=function(a,e){b.debug("onDrop "+a+","+e);var f=c.onDrop(d.game,a,e);return d.$parent.$digest(),f},d.onChange=function(a,c){b.debug("onChange "+a+","+c),d.$parent.$digest()}}]};return d}]).directive("chessgameDebug",[function(){var a={restrict:"A",priority:1,scope:{game:"=chessgameDebug"},template:'<div><button class="btn btn-xs" data-ng-click="_debug = !_debug">show debug</button><div class="game-debug-container" data-ng-show="_debug"><span class="label label-info">game {{game.name}}</span><p><code>game_over()? {{game.game_over()}}</code></p><p><code>fen()? {{game.fen()}}</code></p><p><code>history()? {{game.history()}}</code></p><p><code>in_check()? {{game.in_check()}}</code></p><p><code>in_checkmate()? {{game.in_checkmate()}}</code></p><p><code>in_stalemate()? {{game.in_stalemate()}}</code></p><p><code>in_draw()? {{game.in_draw()}}</code></p><p><code>in_checkmate()? {{game.in_checkmate()}}</code></p><p><code>in_threefold_repetition()? {{game.in_threefold_repetition()}}</code></p><p><code>insufficient_material()? {{game.insufficient_material()}}</code></p><p><code>moves()? {{game.moves()}}</code></p><p><pre style="font-size: 0.7em">{{game.ascii()}}</pre></p></div></div>'};return a}]).directive("allowOnlyLegalMoves",["$window","$log","NywtonChessGameService",function(a,b,c){var d={restrict:"A",priority:1,require:"chessboard",controller:["$scope",function(b){b.game=new a.Chess}],link:function(a,d,e,f){var g=function(b,d,e,f){var g=c.onDragStart(a.game,b,d,e,f);return a.$digest(),g},h=function(b,d,e){var g=f.board(),h=c.onSnapEnd(a.game,g,b,d,e);return a.$digest(),h},i=function(b,d){var e=c.onDrop(a.game,b,d);return a.$digest(),e},j=function(){b.debug("onChange in allowOnlyLegalMoves"),a.$digest()};f.config_push(["onDragStart",g]),f.config_push(["onSnapEnd",h]),f.config_push(["onDrop",i]),f.config_push(["onChange",j])}};return d}])}();